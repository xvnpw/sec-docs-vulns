### Vulnerability List

- Vulnerability Name: HTML Injection in Merge Request Notes
- Description:
    1. An attacker creates a merge request note in GitLab with malicious HTML content.
    2. A Slack user shares a link to this merge request note in a Slack channel where the GitLab Unfurly bot is active.
    3. The bot detects the GitLab URL, parses it, and identifies it as a merge request note.
    4. The `get_note_merge_requests_info` function in `unfurl_message.py` is called to fetch data from the GitLab API for the note.
    5. The bot retrieves the note body, which contains the attacker's malicious HTML.
    6. The bot formats a Slack message attachment using the fetched data, including the raw, unsanitized HTML content from the note body in the `text` field.
    7. The bot sends this Slack message to the channel.
    8. Slack renders the message, including the malicious HTML injected by the attacker, potentially leading to phishing, redirection, or other client-side attacks.
- Impact: An attacker can inject arbitrary HTML into Slack messages viewed by users in the Slack channel. This can be exploited for phishing attacks (displaying fake login forms), redirection to malicious websites, defacement of messages, or potentially, in some cases, client-side scripting attacks within Slack.
- Vulnerability Rank: High
- Currently Implemented Mitigations: None. The code uses HTML sanitization in other parts of the application, but it's missing in the `get_note_merge_requests_info` function specifically for merge request note bodies.
- Missing Mitigations:
    - Implement HTML sanitization for the merge request note body in the `get_note_merge_requests_info` function.
    - Apply the `strip_html_tags` function to the `body` variable in `get_note_merge_requests_info` before using it in the Slack message attachment.
- Preconditions:
    - The attacker has access to a GitLab instance that the GitLab Unfurly bot is configured to unfurl URLs from.
    - The attacker has the ability to create merge requests and add notes to them in the GitLab instance.
    - A Slack user shares a link to a malicious merge request note in a Slack channel where the bot is active.
- Source Code Analysis:
    - In `/code/unfurl_message.py`, the function `get_note_merge_requests_info` is responsible for fetching and formatting information for merge request notes.
    - The code fetches the note `body` directly from the GitLab API response:
      ```python
      data = get_data_from_api(session, api_path)
      ...
      body = data["body"]
      ```
    - This `body` variable, which can contain user-controlled content with HTML tags from GitLab, is then used directly in the `text` field of the Slack attachment after only being shortened by `textwrap.shorten`:
      ```python
      return {
          ...
          "text": textwrap.shorten(body.strip(), width=300, placeholder="â€¦"),
          ...
      }
      ```
    - There is no HTML sanitization step using `strip_html_tags` or any other similar function before including the `body` in the Slack message. This allows any HTML present in the GitLab merge request note body to be passed directly to Slack for rendering.

- Security Test Case:
    1. **Prerequisites:**
        - Deploy the GitLab Unfurly bot and configure it to connect to a Slack workspace and a GitLab instance.
        - Ensure you have an account on the GitLab instance with permissions to create projects, merge requests, and notes.
        - Access to a Slack channel where you can post messages and test the bot's unfurling functionality.
    2. **Steps:**
        a. In the GitLab instance, create a new project.
        b. Create a new merge request in the project.
        c. Add a new note to the merge request with the following content:
           ```html
           <b>Bold text injection</b> <a href="https://example.com">Malicious Link</a> <script>alert("XSS Test")</script>
           ```
        d. Copy the URL of the merge request note. This URL will typically follow the format: `GITLAB_URL/YOUR_PROJECT/merge_requests/MERGE_REQUEST_ID#note_NOTE_ID`.
        e. In the Slack channel, paste the copied merge request note URL and send the message.
        f. Observe the unfurled message generated by the GitLab Unfurly bot in Slack.
    3. **Expected Result:**
        - The Slack message unfurl should render the HTML content from the GitLab merge request note.
        - "Bold text injection" should appear in bold.
        - "Malicious Link" should be displayed as a clickable link to `https://example.com`.
        - While script execution might be blocked by Slack's sanitization, the successful rendering of bold text and the malicious link demonstrates HTML injection.
    4. **Successful Exploitation:** If the HTML formatting (like bold text and hyperlinks) from the GitLab note is rendered in the Slack message, the HTML injection vulnerability is confirmed.