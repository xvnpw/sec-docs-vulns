- vulnerability name: Format String Vulnerability in Logging via `request_category`
- description: An application using the `request-session` library might be vulnerable to a format string attack if it allows user-controlled input to be used as the `request_category` parameter and if the logging system used by the application is susceptible to format string vulnerabilities. When the `request-session` library logs information, it includes the `request_category` in the log messages. If a malicious user can control the `request_category` and inject format string specifiers (e.g., `%x`, `%s`, `%n`), these specifiers might be interpreted by a vulnerable logging system. This could lead to information disclosure (reading server memory), denial of service, or potentially arbitrary code execution on the server, depending on the capabilities of the logging system and the format string vulnerability.
- impact: Information Disclosure, Denial of Service, potentially Arbitrary Code Execution. The severity depends on the logging system's vulnerability and the extent to which an attacker can control the `request_category` parameter.
- vulnerability rank: Medium to High
- currently implemented mitigations: No direct mitigations are implemented in the `request-session` library itself. The library relies on the security of the logging system configured by the application using it.
- missing mitigations:
    - Input sanitization: The `request-session` library could sanitize the `request_category` parameter to remove or escape format string specifiers before including it in log messages. However, this might not be desirable as it could alter the intended logging behavior and might not be a complete solution.
    - Documentation warning: The documentation should explicitly warn users about the potential security risks of using user-provided input as `request_category` if their logging system is vulnerable to format string injection. It should advise users to sanitize or validate the `request_category` parameter if it originates from untrusted sources.
    - Consider structured logging: Encourage users to employ structured logging practices, which are less prone to format string vulnerabilities compared to traditional string formatting in logging.
- preconditions:
    - An application is using the `request-session` library.
    - The application allows user-controlled input to influence or directly set the `request_category` parameter when making requests using `RequestSession`.
    - The logging system configured in the application is vulnerable to format string injection or similar issues when processing log event names or messages that include user-provided input.
- source code analysis:
    - In the `request_session.py` file, the `log` method in the `RequestSession` class constructs the log event name using the `request_category` parameter. For example, in `_log_with_params` and `_exception_log_and_metrics` methods, the `request_category` or a string derived from it becomes part of the `event` parameter passed to the `log` method.
    - The `log` method then forms `event_name = f"{self.log_prefix}.{event}"` and calls the logger using `getattr(self.logger, level)(event_name, **kwargs)`.
    - If the `request_category`, which becomes part of `event_name`, contains format string specifiers and if the `self.logger` (the actual logger configured by the application) interprets these format specifiers, a format string vulnerability arises.
    - The vulnerability is triggered when user input, intended or unintended, containing format string characters is passed as `request_category` and processed by a vulnerable logger via the `request_session` library's logging mechanism.
- security test case:
    - Step 1: Set up a Python application that uses the `request-session` library and configures a basic logger (e.g., `logging.getLogger()`). For demonstration purposes, assume this logger is vulnerable to format string (although standard Python logging is not directly vulnerable in this way with f-strings, the principle can be shown if a hypothetical vulnerable logger is used or if a vulnerable logging configuration is present).
    - Step 2: Create an API endpoint in the application that uses `RequestSession` to make a GET request. This endpoint should accept a parameter (e.g., query parameter `category`) and pass its value as the `request_category` to the `client.get()` method of `RequestSession`.
    - Step 3: As an attacker, send a request to this endpoint with a crafted `category` parameter value that includes format string specifiers. For example: `/?category=%25x%20%25x%20%25x%20%25x`. The `%25x` is URL-encoded `%x`.
    - Step 4: Examine the application logs. If the logging system is vulnerable to format string injection, the logs will show output resulting from the interpretation of the format string specifiers (e.g., hexadecimal values from memory, program crash, or other unexpected behavior instead of literal `%x %x %x %x`). This would confirm the format string vulnerability via the `request_category` parameter.
    - Step 5: To further demonstrate impact, try more dangerous format string specifiers if applicable to the hypothetical vulnerable logger to check for potential for code execution or more significant information disclosure. For real-world testing, it's crucial to use a genuinely vulnerable logger setup or simulate the behavior of one. For standard Python logging, this test case primarily highlights a potential risk if users were to replace the default logger with a vulnerable one and expose `request_category` to user input.