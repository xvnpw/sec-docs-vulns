## Vulnerability List:

- Vulnerability name: Task Deletion via Title Manipulation in Reconciliation
- Description:
    1. An attacker crafts a malicious Markdown file. This file contains task titles that are designed to match existing task titles in the user's Google Tasks, but with subtle differences (e.g., extra spaces, different casing).
    2. The user is tricked into using the `gtasks-md reconcile` command with this malicious Markdown file.
    3. During the reconciliation process in `app/googleapi.py`, the application attempts to match tasks between the local Markdown file and the Google Tasks server based on task titles.
    4. Due to the subtle differences in titles introduced by the attacker, some existing tasks on the Google Tasks server are not correctly matched with tasks in the malicious Markdown file.
    5. The reconciliation logic interprets these unmatched tasks as deletions and proceeds to delete them from the user's Google Tasks.
- Impact: Unintentional deletion of user's Google Tasks data. An attacker can cause significant data loss by crafting a Markdown file that leads to the deletion of important tasks during reconciliation.
- Vulnerability rank: High
- Currently implemented mitigations: None
- Missing mitigations:
    - Implement exact title matching during reconciliation or provide options for different matching strategies.
    - Implement a confirmation step before deleting tasks during reconciliation, especially when a large number of deletions are detected.
    - Provide a diff view of changes before reconciliation to allow users to review and approve changes.
- Preconditions:
    - The attacker needs to trick the user into using a maliciously crafted Markdown file with the `gtasks-md reconcile` command.
    - The attacker needs to know some of the task titles used by the victim to craft the malicious Markdown file effectively.
- Source code analysis:
    1. **`app/googleapi.py` - `reconcile` function:**
        - The `reconcile` function in `GoogleApiService` is responsible for synchronizing local Markdown task lists with the Google Tasks server.
        - It starts by generating reconcile operations (`gen_tasklist_ops`, `gen_task_ops`) which determine whether to insert, delete, or update tasks and task lists.
        - The task matching logic in `gen_task_ops` relies solely on task titles to identify corresponding tasks between the old and new states.

        ```python
        def gen_task_ops(old_tasks: list[Task], new_tasks: list[Task]):
            task_to_op = {}
            for task in old_tasks:
                task_to_op[task.title] = (ReconcileOp.DELETE, task)

            for i, task in enumerate(new_tasks):
                if task.title in task_to_op:
                    task_to_op[task.title] = (
                        ReconcileOp.UPDATE,
                        task_to_op[task.title][1],
                        task,
                        i,
                    )
                else:
                    task_to_op[task.title] = (ReconcileOp.INSERT, task, i)

            return list(task_to_op.values())
        ```
        - This code iterates through `old_tasks` and marks each task for deletion initially.
        - Then, it iterates through `new_tasks`. If a task title in `new_tasks` matches a title in `old_tasks` (using `task.title in task_to_op`), it's marked for update instead of delete. Otherwise, it's marked for insertion.
        - **Vulnerability:** The matching is done using `task.title in task_to_op`, which is a simple string comparison. If the attacker provides a Markdown file where task titles are slightly different from the existing task titles (e.g., extra spaces, different casing), the titles will not be considered a match. Consequently, legitimate tasks from `old_tasks` will be incorrectly identified as deletions.
    2. **`app/googleapi.py` - `apply_task_ops` function:**
        - This function executes the reconcile operations generated by `gen_task_ops`.
        - When a `ReconcileOp.DELETE` operation is encountered, it calls `self.tasks().delete()` to remove the task from the Google Tasks server.

        ```python
        def apply_task_ops(ops, new_tasks, task_list_id):
            # ...
            for op in ops:
                match op:
                    case (ReconcileOp.DELETE, task):
                        batched_request.add(
                            self.tasks().delete(tasklist=task_list_id, task=task.id),
                            delete_callback(task.title),
                        )
                    # ...
            batched_request.execute()
            # ...
        ```
        - If the `gen_task_ops` function incorrectly identifies tasks as deletions due to title mismatch, this function will proceed to delete those tasks from the server.

- Security test case:
    1. **Pre-test setup:**
        - User has `gtasks-md` installed and configured with their Google account.
        - User has a Google Task list named "My Tasks" with the following tasks:
            - "Task to Keep"
            - "Task to Maybe Delete " (note the extra space at the end)
    2. **Attacker's actions:**
        - Attacker creates a malicious Markdown file named `malicious_tasks.md` with the following content:

        ```markdown
        # TODO

        ## My Tasks

        1.  [ ] Task to Keep
        1.  [ ] Task New
        ```
        - Note that "Task to Maybe Delete " is missing and "Task to Keep" is present, but "Task to Maybe Delete " in Google Tasks has an extra space at the end which is not present in malicious file.
    3. **User's actions (triggering the vulnerability):**
        - User is tricked into running the reconcile command with the malicious file:
        ```sh
        gtasks-md reconcile malicious_tasks.md --user default
        ```
    4. **Verification:**
        - After running the command, the user checks their Google Tasks "My Tasks" list.
        - **Expected result (Vulnerability):** The task "Task to Maybe Delete " is deleted from the "My Tasks" list because the reconciliation logic incorrectly identified it as a deletion due to the title mismatch caused by the extra space. "Task to Keep" and "Task New" should be present.
        - **Expected result (Mitigation):** If mitigations are implemented (e.g., exact title matching is replaced with more robust matching, or confirmation step is added), the task "Task to Maybe Delete " should not be deleted, and a warning or confirmation prompt should be displayed to the user about potential deletions.