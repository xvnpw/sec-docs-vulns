- Vulnerability name: CSV Injection in `to_csv()`
- Description: Temporian's `to_csv()` function, via pandas, is vulnerable to CSV injection. Maliciously crafted CSV data loaded using `from_csv()` and then exported using `to_csv()` can contain formulas that are executed when the exported CSV is opened in spreadsheet software.
    - Step 1: An attacker crafts a malicious CSV file. This file contains data in a feature column that is designed to be interpreted as a formula by spreadsheet software (e.g., Excel, LibreOffice Calc). Example: `=cmd|' /C calc'!A0` to execute the calculator on Windows.
    - Step 2: A user loads this malicious CSV file into Temporian using the `tp.from_csv()` function. This step itself does not trigger the vulnerability.
    - Step 3: The user processes the data using Temporian library.
    - Step 4: The user exports the processed Temporian EventSet into a new CSV file using the `tp.to_csv()` function. The potentially malicious content is preserved in the exported CSV.
    - Step 5: The user, or another unsuspecting individual, opens the exported CSV file using spreadsheet software (like Microsoft Excel or LibreOffice Calc) that is vulnerable to CSV injection.
    - Step 6: Upon opening the CSV, the spreadsheet software interprets the malicious content as a formula and executes it. This can lead to arbitrary command execution on the user's machine, or other malicious actions depending on the injected formula.
- Impact: Arbitrary command execution or information disclosure on the user's machine when opening an exported CSV file with vulnerable spreadsheet software.
- Vulnerability rank: Medium
- Currently implemented mitigations: None
- Missing mitigations:
    - Implement sanitization or escaping of formula characters (specifically characters like '=', '@', '+', '-') in string features before exporting to CSV using `tp.to_csv()`. This would prevent spreadsheet software from interpreting these characters as formula initiators.
    - Add documentation to `/code/README.md` or a dedicated security documentation file, warning users about the potential CSV injection vulnerability when exporting data to CSV format. Advise users to be cautious when opening CSV files generated by Temporian, especially if the original data source is untrusted or external.
- Preconditions:
    - The attacker has the ability to create or modify CSV files that are processed by a Temporian application through the `tp.from_csv()` function.
    - The Temporian application exports data to a CSV file using `tp.to_csv()`.
    - A user opens the exported CSV file with spreadsheet software that is vulnerable to CSV injection (e.g., Microsoft Excel, LibreOffice Calc).
- Source code analysis:
    - Vulnerability is located in `/code/temporian/io/csv.py` within the `to_csv()` function.
    - The `to_csv()` function utilizes pandas `df.to_csv()` to write EventSet data to a CSV file.
    - Pandas `to_csv()` function, by default, does not sanitize or escape characters that could be interpreted as formulas by spreadsheet applications.
    - If Temporian EventSet contains string features that originate from or are influenced by external, potentially malicious, CSV data loaded using `from_csv()`, these features might carry formula injection payloads.
    - When `to_csv()` exports this data, the formula characters are preserved, making the exported CSV vulnerable.
- Security test case:
    - Step 1: Create a malicious CSV file named `malicious.csv` with the following content:
      ```csv
      timestamp,feature_1
      1,=cmd|' /C calc'!A0,test_value
      2,normal_value
      ```
      This CSV contains a formula `=cmd|' /C calc'!A0` in the second field of the first row, designed to execute the calculator application on Windows systems when opened by vulnerable spreadsheet software.
    - Step 2: Write a Python script to load `malicious.csv` using Temporian and export it to `exported.csv`:
      ```python
      import temporian as tp

      # Load the malicious CSV file
      data = tp.from_csv("malicious.csv")

      # Export the loaded data to a new CSV file
      tp.to_csv(data, "exported.csv")
      ```
    - Step 3: Execute the Python script to generate `exported.csv`.
    - Step 4: Open the `exported.csv` file using a spreadsheet application that is known to be vulnerable to CSV injection, such as Microsoft Excel or LibreOffice Calc.
    - Step 5: Observe the behavior of the spreadsheet application. If the calculator application is launched (or any other command specified in the malicious formula is executed), it confirms that the CSV injection vulnerability is present.