### Vulnerability List

- Vulnerability Name: Cross-Site Scripting (XSS) vulnerability due to unsanitized output

- Description:
    1. An attacker crafts a malicious input string containing JavaScript code.
    2. This malicious string is provided as either the `reference` or `hypothesis` input to any of the `jiwer` functions, such as `wer`, `mer`, `wil`, `wip`, `cer`, `process_words`, or `process_characters`.
    3. The `jiwer` library processes this input string to calculate error metrics and/or generate alignment visualizations.
    4. If a web application directly displays the output of `jiwer.visualize_alignment()` or error counts (which includes parts of the input strings) in a web page without proper sanitization (like HTML encoding), the injected JavaScript code will be executed in the user's browser.
    5. This can occur when the web application intends to display the ASR evaluation results, including visualizations of alignments and error counts, to users.

- Impact:
    - An attacker can execute arbitrary JavaScript code in the context of a user's browser when they view the ASR evaluation results.
    - This can lead to various malicious actions, including:
        - Stealing user session cookies and hijacking user accounts.
        - Defacing the web page.
        - Redirecting users to malicious websites.
        - Logging user keystrokes or stealing sensitive information displayed on the page.
        - Performing actions on behalf of the user without their consent.

- Vulnerability Rank: High

- Currently Implemented Mitigations:
    - None. The code does not include any explicit sanitization or encoding of input or output strings to prevent XSS. The library focuses on calculating metrics and visualizing alignments, not on secure output rendering for web applications.

- Missing Mitigations:
    - Output Sanitization: The `jiwer` library should sanitize its output, especially the parts intended for visualization (like in `visualize_alignment` and `visualize_error_counts`), by HTML encoding user-provided input strings before including them in the output. This would prevent the browser from interpreting injected scripts as executable code.
    - Documentation Warning: The documentation should explicitly warn users about the potential XSS vulnerability if the output of `jiwer` is directly embedded into web pages without proper sanitization. It should advise users to sanitize the output before displaying it in web contexts.

- Preconditions:
    - A web application uses the `jiwer` library to process user-provided text or text generated by an ASR system.
    - The web application displays the output of `jiwer`, particularly the visualizations or error counts, in a web page.
    - The web application does not sanitize the `jiwer` output before displaying it in the HTML context.

- Source Code Analysis:
    - **File: src/jiwer/alignment.py**
        - Functions `visualize_alignment` and `visualize_error_counts` are responsible for creating string representations of alignments and error counts, which include parts of the input `reference` and `hypothesis` strings.
        - In `visualize_alignment`, the function `_construct_comparison_string` directly uses the `reference` and `hypothesis` words/characters to build the output string. It does not perform any HTML encoding or sanitization.
        - In `visualize_error_counts`, the function `build_list` also directly uses the input words/characters in the output string without sanitization.

    ```python
    # Example from src/jiwer/alignment.py - _construct_comparison_string function

    def _construct_comparison_string(
        reference: List[str],
        hypothesis: List[str],
        ops: List[AlignmentChunk],
        include_space_seperator: bool = False,
        line_width: Optional[int] = None,
    ) -> str:
        # ...
        for op in ops:
            # ...
            for rf, hp, c in zip(ref, hyp, op_chars):
                # ...
                ref_str += f"{rf:>{str_len}}" # Directly using rf (reference word/char)
                hyp_str += f"{hp:>{str_len}}" # Directly using hp (hypothesis word/char)
                # ...
    ```
    - **File: src/jiwer/process.py**
        - Functions `process_words` and `process_characters` process the input strings and generate `WordOutput` and `CharacterOutput` objects. These objects contain the original transformed reference and hypothesis sentences and alignments, which are then used by the visualization functions in `alignment.py`.
        - The processing logic focuses on calculating error metrics and alignments, and does not include any steps for sanitizing or encoding the input text.
    - **File: src/jiwer/cli.py**
        - The CLI tool `jiwer.cli` reads input from files and prints the output to the console. It does not perform any sanitization, as it's designed for command-line usage, not web output.

    - **Visualization Flow:**
        1. User provides input strings to `jiwer.process_words` or `jiwer.process_characters`.
        2. These functions process the input and return `WordOutput` or `CharacterOutput` objects.
        3. The web application calls `jiwer.visualize_alignment(output)` or `jiwer.visualize_error_counts(output)` to get a string representation for display.
        4. These visualization functions directly embed parts of the original (potentially malicious) input strings into the output string without sanitization.
        5. The web application injects this unsanitized string into the HTML of a web page, leading to XSS.

- Security Test Case:
    1. **Setup:** Assume a web application that uses `jiwer` to calculate WER and display the alignment visualization. This application takes user input for reference and hypothesis text and displays the visualization generated by `jiwer.visualize_alignment()`.
    2. **Craft Malicious Input:** As an attacker, prepare a malicious hypothesis string that contains JavaScript code. For example:
        ```
        <img src=x onerror="alert('XSS Vulnerability')" >
        ```
    3. **Provide Malicious Input to Web Application:** Input a normal reference string and the malicious hypothesis string into the web application. For example:
        - Reference: `hello world`
        - Hypothesis: `<img src=x onerror="alert('XSS Vulnerability')" >`
    4. **Trigger Visualization:** Instruct the web application to calculate the WER and display the alignment visualization using `jiwer.visualize_alignment()`.
    5. **Observe XSS Execution:** Check the web page displaying the visualization. If the XSS vulnerability exists, an alert box with the message "XSS Vulnerability" will appear in the browser, indicating that the JavaScript code from the malicious input was executed.
    6. **Verify Lack of Sanitization:** Inspect the HTML source of the web page. You will find that the malicious `<img src=x onerror="alert('XSS Vulnerability')" >` string is directly embedded in the HTML without any HTML encoding, confirming the lack of output sanitization in `jiwer`'s visualization functions.

This test case demonstrates that if a web application directly uses the output of `jiwer.visualize_alignment()` without sanitization, it is vulnerable to XSS. The same vulnerability would apply to `jiwer.visualize_error_counts()` as it also incorporates input strings into its output.