### Vulnerability List

- Vulnerability Name: Path Traversal in Custom Corpus Loading
- Description:
  - An attacker can exploit a path traversal vulnerability by providing a maliciously crafted file path to the `--custom_corpus_path` argument in the training scripts (`train_self_distill.sh` or `train_mutual_distill.sh`).
  - The `load_custom` function in `src/data.py` is responsible for loading a custom corpus from the path specified by `--custom_corpus_path`.
  - This function directly uses the provided path in the `open(fpath, "r")` function without any validation or sanitization.
  - By providing a path like `../../../../etc/passwd`, an attacker can bypass directory restrictions and access files outside the intended corpus directory.
  - When the training script executes, the `load_custom` function will open and attempt to read the file specified by the attacker's path (e.g., `/etc/passwd`), treating its content as sentence pairs for training.

- Impact:
  - An attacker can read arbitrary files on the server where the training script is executed, provided that the user running the script has read permissions to those files.
  - This can lead to information disclosure, where an attacker gains access to sensitive data such as system configuration files, private keys, or other confidential information that the server user has access to.

- Vulnerability Rank: Medium
- Currently Implemented Mitigations:
  - None. The code directly uses the user-provided file path without any validation or sanitization.

- Missing Mitigations:
  - Input validation and sanitization for the `--custom_corpus_path` argument in the training scripts.
  - Implement checks to ensure that the provided path is within an expected directory or restrict access to sensitive directories.
  - Use secure file path handling mechanisms to prevent path traversal attacks.

- Preconditions:
  - The attacker must be able to execute one of the training scripts (`train_self_distill.sh` or `train_mutual_distill.sh`).
  - The attacker must be able to provide command-line arguments to the training script, specifically the `--custom_corpus_path` argument.

- Source Code Analysis:
  - File: `/code/src/data.py`
  - Function: `load_custom(fpath)`
  ```python
  def load_custom(fpath):
      """
      Load custom sentence-pair corpus. Use STS-B's dev set for dev.
      ...
      """
      all_pairs = []
      all_test = {}

      # load custom training corpus
      with open(fpath, "r") as f: # Vulnerable line: fpath from user input is directly used in open()
          lines = f.readlines()
      for line in lines:
          line = line.strip()
          if len(line.split("||")) != 2: continue # skip
          sent1, sent2 = line.split("||")
          all_pairs.append([sent1, sent2])
      ...
  ```
  - The `load_custom` function takes `fpath` as input, which corresponds to the `--custom_corpus_path` argument from the command line.
  - The line `with open(fpath, "r") as f:` directly uses `fpath` to open the file without any checks to ensure it's a safe path.
  - This allows a path traversal attack because if `fpath` contains `../` sequences, it can navigate out of the intended directory and access files elsewhere on the system.

- Security Test Case:
  - Step 1: Prepare a malicious path file.
    - Create a text file named `malicious_corpus_path.txt` with the following content:
      ```text
      ../../../../../../../../../../../../../../etc/passwd
      ```
    - This file contains a path that attempts to traverse to the root directory and then access the `/etc/passwd` file.

  - Step 2: Run the training script with the malicious path.
    - Execute the `train_self_distill.sh` script, providing the `malicious_corpus_path.txt` file as the `--custom_corpus_path` argument and specifying the `custom` task:
      ```bash
      bash train_self_distill.sh 0 --task custom --custom_corpus_path malicious_corpus_path.txt
      ```
    - Or execute the `train_mutual_distill.sh` script:
      ```bash
      bash train_mutual_distill.sh 0,1 --task custom --custom_corpus_path malicious_corpus_path.txt
      ```

  - Step 3: Observe the output and logs.
    - Examine the output and error logs generated by the training script.
    - If the vulnerability is successfully exploited, the script will attempt to process the content of `/etc/passwd` as sentence pairs. This will likely lead to errors during the training process, such as data format errors or encoding issues, because `/etc/passwd` is not a valid corpus file in the expected format.
    - To confirm the vulnerability more directly, you could temporarily modify the `load_custom` function in `src/data.py` to print the lines read from the file to standard output before further processing. If the content of `/etc/passwd` is printed, it confirms that the path traversal was successful and the file was read.

  - Step 4: Expected Result
    - The training script should attempt to read the `/etc/passwd` file due to the path traversal vulnerability.
    - While the script will likely fail to train correctly due to the invalid corpus data from `/etc/passwd`, the successful opening and reading of `/etc/passwd` (or attempt thereof, potentially resulting in a permission error if the user doesn't have read access) demonstrates the path traversal vulnerability.
    - In a real attack scenario, a more sophisticated attacker might target readable configuration files or logs to extract sensitive information.