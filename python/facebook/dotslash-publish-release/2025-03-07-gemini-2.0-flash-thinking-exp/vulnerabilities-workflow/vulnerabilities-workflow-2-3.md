### Vulnerability List:

- Vulnerability Name: Configuration File Injection leading to Malicious DotSlash File Generation
- Description:
  1. An attacker gains write access to the GitHub repository where the `dotslash-publish-release` action is used. This could be achieved through compromised credentials, supply chain attack, or insider threat.
  2. The attacker modifies the `dotslash-config.json` file located within the repository (e.g., `.github/workflows/dotslash-config.json`).
  3. Within the `dotslash-config.json`, the attacker alters the `outputs` section. Specifically, they modify the `platforms` entries to change the `providers` URLs and potentially the `digest` and `size` to point to malicious executables hosted on attacker-controlled infrastructure or even within the compromised repository's releases.
  4. Once the configuration is modified and committed, the GitHub Actions workflow that uses `dotslash-publish-release` is triggered (e.g., upon a new release or workflow completion of artifact upload).
  5. The `dotslash-publish-release` action executes, reads the modified `dotslash-config.json`, and generates DotSlash files based on the attacker's manipulated configuration.
  6. The action uploads these malicious DotSlash files to the GitHub release, replacing or adding to the existing DotSlash files.
  7. Users who download and execute the DotSlash files from the compromised release will unknowingly download and run the malicious executables specified in the attacker's modified configuration, instead of the legitimate executables intended by the repository maintainers.
- Impact:
  - Users who rely on the DotSlash files generated by this action to download and run executables will be tricked into downloading and executing malware.
  - This can lead to complete compromise of the user's system, including data theft, malware installation, and further propagation of attacks.
  - The reputation of the repository and the project is severely damaged, as users lose trust in the integrity of the distributed software.
- Vulnerability Rank: High
- Currently Implemented Mitigations:
  - None in the `dotslash-publish-release` action itself to prevent configuration file modification.
  - The security of this action relies entirely on the security of the repository where it is used. GitHub provides repository access controls and security features, but these are not specific mitigations within the action's code.
- Missing Mitigations:
  - **Input Validation for `dotslash-config.json`:** While complex, some level of schema validation for `dotslash-config.json` could be implemented to detect obviously malicious patterns or configurations. However, this might be difficult to create robustly without limiting legitimate use cases.
  - **Integrity Checks for `dotslash-config.json`:**  Consider signing or checksumming the `dotslash-config.json` file and verifying its integrity before processing it in the action. This would require a mechanism to securely store and manage the signing key/checksum.
  - **Documentation Enhancement:** Clearly document the security risks associated with using this action and emphasize the importance of securing repository access and monitoring for unauthorized configuration changes. Highlight that the action's security is directly tied to the repository's security.
- Preconditions:
  - The attacker must have write access to the GitHub repository where the `dotslash-publish-release` action is configured and used.
  - The repository must be using the `dotslash-publish-release` action to generate DotSlash files as part of its release process.
- Source Code Analysis:
  - **`process_config.py` - Configuration Loading:**
    - The script starts by parsing arguments, including `--config`, which specifies the path to the configuration file (`dotslash-config.json`).
    - Lines 69-81 handle loading the configuration file:
      ```python
      if args.local_config:
          print(args.config)
          with open(args.config, "r") as f:
              config = json.load(f)
      else:
          config = get_config(
              path_to_config=args.config,
              config_ref=args.config_ref,
              github_repository=repo,
              api_url=api_server_url,
          )
      ```
      - If `--local-config` is used, it directly reads the file from the local filesystem path provided by `--config`.
      - Otherwise, it uses the `get_config` function to fetch the `dotslash-config.json` from the GitHub repository using the GitHub API.
    - **`process_config.py` - `get_config` function:**
      ```python
      def get_config(
          *, path_to_config: str, config_ref: str, github_repository: str, api_url: str
      ) -> Any:
          args = [
              "gh",
              "api",
              "-X",
              "GET",
              f"{api_url}/repos/{github_repository}/contents/{path_to_config}",
              "-H",
              "Accept: application/vnd.github.raw",
              "-f",
              f"ref={config_ref}",
          ]
          output = subprocess.check_output(args)
          return json.loads(output.decode("utf-8"))
      ```
      - This function uses the `gh api` command to retrieve the content of `dotslash-config.json` from the GitHub repository at the specified `config_ref` (commit SHA or branch).
      - The content is fetched as raw content and then parsed as JSON using `json.loads`.
    - **`process_config.py` - Processing `outputs` and generating manifest:**
      - Lines 83-92 validate the basic structure of the config:
        ```python
        outputs = config.get(OUTPUTS_PARAM)
        if not outputs:
            logging.error(f"no {OUTPUTS_PARAM} specified in config:")
            logging.error(json.dumps(config, indent=2))
            return 1

        exclude_http_provider = config.get(EXCLUDE_HTTP_PROVIDER_PARAM, False)
        if not isinstance(exclude_http_provider, bool):
            logging.error(
                f'"{EXCLUDE_HTTP_PROVIDER_PARAM}" field must be a boolean, but was `{exclude_http_provider}`'
            )
            return 1
        exclude_github_release_provider = config.get(EXCLUDE_GITHUB_PROVIDER_PARAM, False)
        if not isinstance(exclude_github_release_provider, bool):
            logging.error(
                f'"{EXCLUDE_GITHUB_PROVIDER_PARAM}" field must be a boolean, but was `{exclude_github_release_provider}`'
            )
            return 1
        ```
      - Lines 100-101 iterate through the `outputs` defined in the config:
        ```python
        for output_filename, output_config in outputs.items():
            platform_entries = map_platforms(output_config, name_to_asset)
            ...
        ```
      - The `map_platforms` function (lines 294-361) uses the `output_config` (which comes directly from the loaded `dotslash-config.json`) to determine which release assets to include in the DotSlash file based on `name` or `regex` properties.
      - The `generate_manifest_file` function (lines 121-291) takes the `platform_entries` (derived from the config) and constructs the DotSlash file content. Critically, it uses the `asset["url"]` directly from the fetched release assets and combines it with other configuration from `dotslash-config.json` to build the providers list in the DotSlash manifest.
      - The generated manifest is then uploaded to the release using `gh release upload` (lines 111-120).

  - **Visualization:**

    ```
    [Attacker Modifies dotslash-config.json in Repository] --> GitHub Repository

    GitHub Actions Workflow (triggered by release/workflow_run) --> Executes dotslash-publish-release action

    dotslash-publish-release action:
    1. Reads modified dotslash-config.json from repository.
    2. Fetches release assets (legitimate assets).
    3. Uses attacker-modified config to generate DotSlash file with potentially malicious URLs.
    4. Uploads malicious DotSlash file to GitHub Release.

    [User Downloads and Executes Malicious DotSlash File from Release] --> User System Compromised
    ```

  - **Conclusion:** The source code directly uses the configuration from `dotslash-config.json` to generate the DotSlash manifest file, including the URLs of the executables. There is no validation or sanitization of the configuration content that could prevent the injection of malicious URLs.

- Security Test Case:
  1. **Setup:**
     - Create a new public GitHub repository.
     - Create a GitHub Actions workflow in `.github/workflows/dotslash.yml` that uses the `dotslash-publish-release` action, similar to the example in the README.md.
     - Create a `dotslash-config.json` file in `.github/workflows/` directory, similar to the example, pointing to some existing release assets in your repository (you might need to create a dummy release with some assets first).
     - Ensure the workflow is triggered on `workflow_run` completion of your release workflow.
  2. **Initial Run (Baseline):**
     - Create a release in your repository with some dummy assets.
     - Trigger the workflow that uploads these assets.
     - Verify that the `dotslash-publish-release` action runs successfully and generates DotSlash files in the release, pointing to your dummy assets. Download and inspect the DotSlash file to confirm it points to the correct URLs.
  3. **Malicious Configuration Injection:**
     - Modify the `.github/workflows/dotslash-config.json` file in your repository.
     - In the `outputs` -> `platforms` section, change the `providers` -> `url` in one or more platform entries to point to a malicious executable or a harmless test file hosted on a public URL (e.g., `https://example.com/malicious.exe` or a simple shell script that prints a message).
     - Commit and push the modified `dotslash-config.json` to the repository.
  4. **Trigger Action with Malicious Config:**
     - Create a new release (or re-run the workflow associated with the previous release if possible in your setup). This should trigger the `dotslash-publish-release` workflow again with the modified configuration.
  5. **Verify Malicious DotSlash File:**
     - After the workflow completes successfully, download the generated DotSlash file from the new release.
     - Inspect the contents of the DotSlash file. Verify that the `providers` -> `url` entries now point to the malicious URL you configured in step 3.
  6. **Attempt to Execute (Simulated):**
     - If the DotSlash file is configured to download a harmless test file, execute the DotSlash file.
     - Observe if the DotSlash client attempts to download the file from the malicious URL you specified in `dotslash-config.json`. If you used a harmless test file, verify that it is downloaded (or the script executes as expected).

This test case demonstrates that by modifying `dotslash-config.json`, an attacker can successfully manipulate the generated DotSlash files to point to arbitrary URLs, confirming the configuration injection vulnerability.