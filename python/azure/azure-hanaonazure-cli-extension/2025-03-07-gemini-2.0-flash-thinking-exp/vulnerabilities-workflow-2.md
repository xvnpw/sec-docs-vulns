## Combined Vulnerability List

### Vulnerability 1: SSH Public Key Injection in HANA Instance Creation

- **Vulnerability Name:** SSH Public Key Injection in HANA Instance Creation
- **Description:**
    1. An attacker can manipulate the `--ssh-public-key` parameter during the `az hanainstance create` command execution.
    2. The attacker crafts a malicious SSH public key and provides it as the value for the `--ssh-public-key` parameter.
    3. The Azure CLI extension passes this malicious SSH public key directly to the Azure HANA instance creation API without any validation or sanitization.
    4. The Azure HANA instance is provisioned with the attacker's SSH public key added to the authorized keys.
    5. The attacker can then gain unauthorized SSH access to the newly created HANA instance using the corresponding private key, bypassing intended access controls.
- **Impact:**
    - An attacker gains unauthorized SSH access to the SAP HANA instance.
    - This allows the attacker to potentially compromise the entire HANA instance, including accessing sensitive data, modifying configurations, and disrupting services.
    - Depending on the HANA instance's role and network configuration, this could lead to further lateral movement within the Azure environment.
- **Vulnerability Rank:** High
- **Currently Implemented Mitigations:**
    - None. The code directly uses the provided SSH public key without any validation.
- **Missing Mitigations:**
    - Input validation and sanitization for the `--ssh-public-key` parameter should be implemented.
    - The extension should validate the format and content of the SSH public key to ensure it is a valid and safe key.
    - Consider using a secure method for users to manage SSH keys, potentially through Azure Key Vault or managed identities, instead of directly passing public keys through the CLI.
- **Preconditions:**
    - The attacker needs to convince a user with Azure CLI access and permissions to create HANA instances to execute the `az hanainstance create` command.
    - The attacker needs to be able to provide a malicious SSH public key as part of the command parameters.
- **Source Code Analysis:**
    - File: `/code/azext_hanaonazure/custom.py`
    - Function: `create_hanainstance`
    ```python
    def create_hanainstance(client, location, resource_group_name, instance_name, partner_node_id, ssh_public_key, os_computer_name, ip_address):
        try:
            from .modules_sdk.v2017_11_03_preview.models_py3 import OSProfile
            from .modules_sdk.v2017_11_03_preview.models_py3 import IpAddress
            from .modules_sdk.v2017_11_03_preview.models_py3 import NetworkProfile
            from .modules_sdk.v2017_11_03_preview.models_py3 import HanaInstance
        except (SyntaxError, ImportError):
            from .modules_sdk.v2017_11_03_preview.models import OSProfile
            from .modules_sdk.v2017_11_03_preview.models import IpAddress
            from .modules_sdk.v2017_11_03_preview.models import NetworkProfile
            from .modules_sdk.v2017_11_03_preview.models import HanaInstance

        hana_instance_to_create = HanaInstance(location=location,
                                               hardware_profile=None,
                                               storage_profile=None,
                                               os_profile=OSProfile(computer_name=os_computer_name,
                                                                    ssh_public_key=ssh_public_key), # Vulnerable line: ssh_public_key is used directly
                                               network_profile=NetworkProfile(network_interfaces=[IpAddress(ip_address=ip_address)]),
                                               partner_node_id=partner_node_id)

        return client.create(resource_group_name, instance_name, hana_instance_to_create)
    ```
    - The `create_hanainstance` function takes the `ssh_public_key` parameter directly from the CLI input.
    - It then creates an `OSProfile` object and directly assigns the `ssh_public_key` to the `ssh_public_key` property of the `OSProfile`.
    - This `OSProfile` object is then used as part of the `HanaInstance` creation request sent to the Azure API.
    - There is no validation or sanitization of the `ssh_public_key` parameter before it is used in the API request.
    - This direct and unvalidated use of user-provided input allows for the SSH public key injection vulnerability.

- **Security Test Case:**
    1. **Prerequisites:**
        - An Azure subscription with permissions to create HANA instances.
        - Azure CLI with the `sap-hana` extension installed and configured.
        - An SSH key pair generated by the attacker (attacker_private_key, attacker_public_key).
    2. **Step 1: Prepare Malicious SSH Public Key:**
        - The attacker has already generated `attacker_public_key`.
    3. **Step 2: Execute `az hanainstance create` command with malicious SSH key:**
        ```bash
        az hanainstance create \
            --location <location> \
            --resource-group <resource_group_name> \
            --instance-name <hana_instance_name> \
            --partner-node-id <partner_node_id> \
            --ssh-public-key "$(cat attacker_public_key)" \ # Inject attacker's public key
            --os-computer-name <computer_name> \
            --ip-address <ip_address>
        ```
        - Replace placeholders like `<location>`, `<resource_group_name>`, `<hana_instance_name>`, `<partner_node_id>`, `<computer_name>`, and `<ip_address>` with valid values for your Azure environment.
    4. **Step 3: SSH into the HANA Instance:**
        - After the HANA instance is successfully created, attempt to SSH into the instance using the private key corresponding to the injected public key (`attacker_private_key`):
        ```bash
        ssh <username>@<hana_instance_ip_address> -i attacker_private_key
        ```
        - Replace `<username>` with a valid username for the HANA instance OS (e.g., root or azureuser) and `<hana_instance_ip_address>` with the IP address of the newly created HANA instance.
    5. **Step 4: Verify Successful Unauthorized Access:**
        - If the attacker can successfully SSH into the HANA instance using `attacker_private_key`, the vulnerability is confirmed.
        - The attacker has gained unauthorized access by injecting their SSH public key during instance creation.

### Vulnerability 2: Sensitive Data Exposure via Command-Line History

- **Vulnerability Name:** Sensitive Data Exposure via Command-Line History
- **Description:**
    1. A user executes an Azure CLI command using the `az sapmonitor provider-instance create` command to create a provider instance for SAP Monitor.
    2. The user includes sensitive credentials, such as database passwords, directly within the `--provider-instance-properties` parameter as shown in the `README.md` documentation. For example:
        ```bash
        az sapmonitor provider-instance create \
            --resource-group $RESOURCE_GROUP \
            --monitor-name $SAP_MONITOR_NAME \
            --provider-instance-name $PROVIDER_INSTANCE_NAME \
            --provider-instance-type SapHana \
            --provider-instance-properties '{"hanaHostname":"10.0.0.6","hanaDbName":"SYSTEMDB","hanaDbSqlPort":30013,"hanaDbUsername":"SYSTEM"," hanaDbPassword":"password"}'
        ```
    3. The shell command, including the plaintext password, is recorded in the user's shell history file (e.g., `.bash_history` for Bash, `.zsh_history` for Zsh).
    4. An attacker gains unauthorized access to the user's system or account. This could be through various means such as malware, phishing, or insider threat.
    5. The attacker reads the shell history file.
    6. The attacker finds the previously executed Azure CLI command containing the plaintext password.
    7. The attacker extracts the sensitive credentials (e.g., `hanaDbPassword`) from the command.
    8. The attacker uses these credentials to gain unauthorized access to the SAP HANA system, potentially leading to data breaches or further system compromise.
- **Impact:**
    Successful exploitation of this vulnerability can lead to the exposure of sensitive credentials for SAP HANA systems. An attacker with access to these credentials can:
    1. Gain unauthorized access to SAP HANA databases.
    2. Read, modify, or delete sensitive data within the SAP HANA system.
    3. Potentially pivot to other systems or resources accessible from the compromised SAP HANA environment.
    4. Cause significant business disruption and financial loss due to data breaches, system downtime, or regulatory fines.
- **Vulnerability Rank:** High
- **Currently Implemented Mitigations:**
    Key Vault integration is implemented for storing and retrieving database passwords. In `azext_hanaonazure/custom.py`, the `create_providerinstance` function includes logic to handle `hanaDbPasswordKeyVaultUrl` and `keyVaultId` in `provider_instance_properties`. This allows users to securely manage passwords using Azure Key Vault instead of directly providing them in the command-line.
- **Missing Mitigations:**
    1. Remove or deprecate the direct password input option (`hanaDbPassword`, `sqlPassword` etc.) in command-line parameters to enforce secure credential management practices.
    2. Implement a clear warning message in the CLI when users attempt to use direct password input in commands. This warning should advise against this practice and strongly recommend using secure alternatives like Azure Key Vault.
    3. Update the `README.md` and help documentation to remove examples that show passwords in command-line parameters and instead emphasize the use of Azure Key Vault for secure credential management. Provide clear instructions and examples on how to use Key Vault with the extension.
- **Preconditions:**
    1. The user must use the `az sapmonitor provider-instance create` command or similar commands that accept sensitive credentials as direct command-line parameters.
    2. The user must choose to provide the sensitive credentials directly in the command-line parameter (e.g., `--provider-instance-properties '{"hanaDbPassword":"password"}'`) instead of using secure alternatives like Key Vault.
    3. The user's shell history must be enabled and accessible to a potential attacker.
- **Source Code Analysis:**
    1. File: `/code/azext_hanaonazure/custom.py`
    2. Function: `create_providerinstance`
    3. The function `create_providerinstance` is responsible for handling the creation of provider instances for SAP Monitor.
    4. It takes `provider_instance_properties` as a parameter, which is expected to be a JSON string.
    5. ```python
       def create_providerinstance(
             cmd,
             client,
             resource_group_name,
             monitor_name,
             provider_instance_name,
             provider_instance_type,
             provider_instance_properties, # Vulnerable parameter
             provider_instance_metadata=None):
           import json
           properties_json = json.loads(provider_instance_properties) # Parses JSON properties, including potential passwords
       ```
    6. The code parses the `provider_instance_properties` JSON string using `json.loads()`. This JSON string, supplied directly by the user in the command line, can contain sensitive information like `hanaDbPassword` as shown in `README.md`.
    7. While the code includes a conditional block to handle Key Vault URLs for `SapHana` provider type:
       ```python
       if provider_instance_type == 'SapHana':
           if 'hanaDbPasswordKeyVaultUrl' in properties_json and 'keyVaultId' in properties_json:
               # Keyvault URL was passed in
               # ... Key Vault integration logic ...
           elif 'hanaDbPassword' not in properties_json:
               raise ValueError("Either hanaDbPassword or both hanaDbPasswordKeyVaultUrl and keyVaultId.")
       ```
    8. This Key Vault integration is a mitigation, but the code still accepts and processes `hanaDbPassword` directly from `properties_json` if Key Vault parameters are not provided.
    9. The `README.md` examples encourage users to pass passwords directly within `provider_instance_properties`, leading to the vulnerability.

- **Security Test Case:**
    1. Precondition: Ensure Azure CLI with `sap-hana` extension is installed and configured.
    2. Step 1: Execute the `az sapmonitor provider-instance create` command with a plaintext password in `--provider-instance-properties`. Replace placeholders with your actual resource group, monitor name, provider instance name, and a test password.
        ```bash
        az sapmonitor provider-instance create \
            --resource-group <your_resource_group> \
            --monitor-name <your_monitor_name> \
            --provider-instance-name test-provider-instance \
            --provider-instance-type SapHana \
            --provider-instance-properties '{"hanaHostname":"<hana_hostname>","hanaDbName":"SYSTEMDB","hanaDbSqlPort":30013,"hanaDbUsername":"SYSTEM","hanaDbPassword":"P@$$wOrd123"}'
        ```
        *(Note: Replace `<hana_hostname>` with a placeholder or a non-production HANA hostname for testing purposes. This test case is to demonstrate credential exposure in history, not to actually connect to HANA.)*
    3. Step 2: Check Shell History.
        - For Bash, use: `history | grep "az sapmonitor provider-instance create"`
        - For Zsh, use: `history | grep "az sapmonitor provider-instance create"`
        - For PowerShell, use: `Get-History | Where-Object {$_.CommandLine -like "*az sapmonitor provider-instance create*"}`
    4. Step 3: Observe the output. The command you executed in Step 1, including the plaintext password `P@$$wOrd123` (or your chosen password), should be present in the shell history.
    5. Step 4: (Simulate Attacker) As an attacker who has gained access to the user's shell environment, retrieve the shell history file (e.g., `.bash_history`).
    6. Step 5: (Simulate Attacker) Search the history file for the `az sapmonitor provider-instance create` command.
    7. Step 6: (Simulate Attacker) Extract the plaintext password `P@$$wOrd123` from the command.
    8. Step 7: (Simulate Attacker) The attacker now possesses the plaintext password that was intended to be secret.