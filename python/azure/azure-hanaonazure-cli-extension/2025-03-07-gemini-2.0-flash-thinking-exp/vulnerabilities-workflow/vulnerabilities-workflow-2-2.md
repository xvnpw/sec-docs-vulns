- Vulnerability Name: SSH Public Key Injection in HANA Instance Creation
- Description:
    1. An attacker can manipulate the `--ssh-public-key` parameter during the `az hanainstance create` command execution.
    2. The attacker crafts a malicious SSH public key and provides it as the value for the `--ssh-public-key` parameter.
    3. The Azure CLI extension passes this malicious SSH public key directly to the Azure HANA instance creation API without any validation or sanitization.
    4. The Azure HANA instance is provisioned with the attacker's SSH public key added to the authorized keys.
    5. The attacker can then gain unauthorized SSH access to the newly created HANA instance using the corresponding private key, bypassing intended access controls.
- Impact:
    - An attacker gains unauthorized SSH access to the SAP HANA instance.
    - This allows the attacker to potentially compromise the entire HANA instance, including accessing sensitive data, modifying configurations, and disrupting services.
    - Depending on the HANA instance's role and network configuration, this could lead to further lateral movement within the Azure environment.
- Vulnerability Rank: High
- Currently Implemented Mitigations:
    - None. The code directly uses the provided SSH public key without any validation.
- Missing Mitigations:
    - Input validation and sanitization for the `--ssh-public-key` parameter should be implemented.
    - The extension should validate the format and content of the SSH public key to ensure it is a valid and safe key.
    - Consider using a secure method for users to manage SSH keys, potentially through Azure Key Vault or managed identities, instead of directly passing public keys through the CLI.
- Preconditions:
    - The attacker needs to convince a user with Azure CLI access and permissions to create HANA instances to execute the `az hanainstance create` command.
    - The attacker needs to be able to provide a malicious SSH public key as part of the command parameters.
- Source Code Analysis:
    - File: `/code/azext_hanaonazure/custom.py`
    - Function: `create_hanainstance`
    ```python
    def create_hanainstance(client, location, resource_group_name, instance_name, partner_node_id, ssh_public_key, os_computer_name, ip_address):
        try:
            from .modules_sdk.v2017_11_03_preview.models_py3 import OSProfile
            from .modules_sdk.v2017_11_03_preview.models_py3 import IpAddress
            from .modules_sdk.v2017_11_03_preview.models_py3 import NetworkProfile
            from .modules_sdk.v2017_11_03_preview.models_py3 import HanaInstance
        except (SyntaxError, ImportError):
            from .modules_sdk.v2017_11_03_preview.models import OSProfile
            from .modules_sdk.v2017_11_03_preview.models import IpAddress
            from .modules_sdk.v2017_11_03_preview.models import NetworkProfile
            from .modules_sdk.v2017_11_03_preview.models import HanaInstance

        hana_instance_to_create = HanaInstance(location=location,
                                               hardware_profile=None,
                                               storage_profile=None,
                                               os_profile=OSProfile(computer_name=os_computer_name,
                                                                    ssh_public_key=ssh_public_key), # Vulnerable line: ssh_public_key is used directly
                                               network_profile=NetworkProfile(network_interfaces=[IpAddress(ip_address=ip_address)]),
                                               partner_node_id=partner_node_id)

        return client.create(resource_group_name, instance_name, hana_instance_to_create)
    ```
    - The `create_hanainstance` function takes the `ssh_public_key` parameter directly from the CLI input.
    - It then creates an `OSProfile` object and directly assigns the `ssh_public_key` to the `ssh_public_key` property of the `OSProfile`.
    - This `OSProfile` object is then used as part of the `HanaInstance` creation request sent to the Azure API.
    - There is no validation or sanitization of the `ssh_public_key` parameter before it is used in the API request.
    - This direct and unvalidated use of user-provided input allows for the SSH public key injection vulnerability.

- Security Test Case:
    1. **Prerequisites:**
        - An Azure subscription with permissions to create HANA instances.
        - Azure CLI with the `sap-hana` extension installed and configured.
        - An SSH key pair generated by the attacker (attacker_private_key, attacker_public_key).
    2. **Step 1: Prepare Malicious SSH Public Key:**
        - The attacker has already generated `attacker_public_key`.
    3. **Step 2: Execute `az hanainstance create` command with malicious SSH key:**
        ```bash
        az hanainstance create \
            --location <location> \
            --resource-group <resource_group_name> \
            --instance-name <hana_instance_name> \
            --partner-node-id <partner_node_id> \
            --ssh-public-key "$(cat attacker_public_key)" \ # Inject attacker's public key
            --os-computer-name <computer_name> \
            --ip-address <ip_address>
        ```
        - Replace placeholders like `<location>`, `<resource_group_name>`, `<hana_instance_name>`, `<partner_node_id>`, `<computer_name>`, and `<ip_address>` with valid values for your Azure environment.
    4. **Step 3: SSH into the HANA Instance:**
        - After the HANA instance is successfully created, attempt to SSH into the instance using the private key corresponding to the injected public key (`attacker_private_key`):
        ```bash
        ssh <username>@<hana_instance_ip_address> -i attacker_private_key
        ```
        - Replace `<username>` with a valid username for the HANA instance OS (e.g., root or azureuser) and `<hana_instance_ip_address>` with the IP address of the newly created HANA instance.
    5. **Step 4: Verify Successful Unauthorized Access:**
        - If the attacker can successfully SSH into the HANA instance using `attacker_private_key`, the vulnerability is confirmed.
        - The attacker has gained unauthorized access by injecting their SSH public key during instance creation.