## Vulnerability List

- Vulnerability Name: Template Parameter Injection leading to Insecure Resource Creation
  - Description:
    1. An attacker crafts a malicious AWS SAM template.
    2. The malicious template includes a Serverless::Function resource.
    3. In the `Properties` section of the function, the attacker injects a parameter into the `Policies` property, attempting to escalate permissions. For example, using a parameter to define a policy template value or directly inject a policy statement.
    4. The attacker tricks a user into deploying this malicious SAM template using the SAM CLI or AWS CloudFormation.
    5. The SAM transform processes the template without proper validation of the injected parameter in the `Policies` property.
    6. The CloudFormation template generated by the SAM transform includes the attacker-injected, overly permissive IAM policies.
    7. AWS CloudFormation deploys the stack, creating a Lambda function with the attacker-specified, overly permissive IAM role.
  - Impact:
    - Creation of a Lambda function with an overly permissive IAM role, granting excessive privileges that could be exploited by the attacker or compromised function.
  - Vulnerability rank: High
  - Currently implemented mitigations: None
  - Missing mitigations:
    - Implement robust input validation within the SAM transform to sanitize and validate SAM template parameters, especially in security-sensitive properties like `Policies`.
    - Define a strict schema for SAM templates and enforce validation during the transformation process.
    - Consider using a safe evaluation method for template parameters to prevent code injection.
  - Preconditions:
    - User deploys a malicious SAM template.
    - SAM transform processes the template without proper input validation.
  - Source code analysis:
    - No new source code provided in this batch of files. The vulnerability still exists as no mitigations are implemented in the provided code, which focuses on testing functionalities like function resources, logical ID generation, and deployment preferences rather than security. The files like `test_function_resources.py` show how SAM functions are processed and converted to CloudFormation, but do not include any validation or sanitization logic for the `Policies` property.
  - Security test case:
    1. Create a malicious SAM template (template.yaml) with the following content:
    ```yaml
    Transform: AWS::Serverless-2016-10-31
    Parameters:
      MaliciousPolicy:
        Type: String
        Default: '{"Statement": [{"Effect": "Allow", "Action": ["*"], "Resource": ["*"]}]}'
    Resources:
      MaliciousFunction:
        Type: AWS::Serverless::Function
        Properties:
          CodeUri: s3://sam-demo-bucket/hello.zip
          Handler: index.handler
          Runtime: python3.9
          Policies: !Sub '${MaliciousPolicy}'
    ```
    2. Deploy this template using SAM CLI: `sam deploy --template-file template.yaml --stack-name malicious-sam-app --capabilities CAPABILITY_IAM`
    3. After deployment, inspect the IAM role created for `MaliciousFunction`.
    4. Verify that the IAM role's policy includes the overly permissive statement `{"Effect": "Allow", "Action": ["*"], "Resource": ["*"]}` injected via the `MaliciousPolicy` parameter.
    5. If the IAM role contains the malicious policy, the vulnerability is confirmed.