### Vulnerability List

* Vulnerability Name: Insecure Log File Permissions
* Description:
    1. The `ImdsPacketAnalyzer` tool logs detected IMDSv1 and IMDSv2 calls to a log file located at `/var/log/imds/imds-trace.log`.
    2. While the tool attempts to restrict permissions on the log directory `/var/log/imds` to `0o600` (read/write for owner only, which is root), it does not explicitly set permissions for the log file `imds-trace.log` itself.
    3. Consequently, the log file `imds-trace.log` may inherit default file permissions, which could allow unauthorized users with local read access to the EC2 instance to read the log file.
    4. An attacker with read access to the EC2 instance can read `/var/log/imds/imds-trace.log` and identify processes making IMDSv1 calls.
    5. This information reveals potential vulnerabilities within those identified processes that could be further exploited to compromise the EC2 instance.

* Impact:
    - An attacker gaining unauthorized read access to the EC2 instance can leverage the log files to perform reconnaissance.
    - By identifying processes making IMDSv1 calls, the attacker gains valuable information about potential weaknesses in the instance's security posture.
    - This reconnaissance can be a stepping stone for further attacks targeting the identified vulnerable processes, potentially leading to full compromise of the EC2 instance.

* Vulnerability Rank: Medium

* Currently Implemented Mitigations:
    - The code attempts to set permissions on the log directory `/var/log/imds` to `0o600` in `src/imds_snoop.py` within the `if(__name__ == "__main__")` block:
    ```python
    if not os.path.exists(LOG_IMDS_FOLDER):
        os.makedirs(LOG_IMDS_FOLDER)

    st = os.stat(LOG_IMDS_FOLDER)
    if bool(st.st_mode & 0o00077):
        print("Setting log folder to root RW access only, permission was: " + str(oct(st.st_mode & 0o00777)))
        os.chmod(LOG_IMDS_FOLDER, 0o600)  # only user RW needed.
    ```
    - The README.md implicitly suggests securing the log files by mentioning "If the log files generated by this tool are not properly secured with appropriate file permissions...".

* Missing Mitigations:
    - Explicitly set restrictive permissions (e.g., `0o600`) on the log file `/var/log/imds/imds-trace.log` after it is created by the `RotatingFileHandler` in `src/imds_snoop.py`. This can be done by adding `os.chmod(log_file_path, 0o600)` after the log file handler is initialized, where `log_file_path` is the path to the log file.

* Preconditions:
    1. The `ImdsPacketAnalyzer` tool must be deployed and running on an EC2 instance.
    2. The tool must have generated log files containing information about IMDS calls.
    3. An attacker must have gained unauthorized read access to the EC2 instance. This could be achieved through various means, such as exploiting other vulnerabilities in the instance or gaining access through compromised credentials.

* Source Code Analysis:
    1. In `src/imds_snoop.py`, the log directory is defined as `LOG_IMDS_FOLDER = "/var/log/imds"`.
    2. The log file path is implicitly defined within the `RotatingFileHandler` initialization: `RotatingFileHandler('/var/log/imds/imds-trace.log', ...)`.
    3. The code correctly attempts to set permissions on the log directory using `os.chmod(LOG_IMDS_FOLDER, 0o600)`.
    4. However, there is no corresponding `os.chmod` call to set permissions on the log file `/var/log/imds/imds-trace.log` after it's created by the `RotatingFileHandler`.
    5. The `RotatingFileHandler` in Python's `logging` library, by default, creates files with the system's default file permissions (umask). This means that unless the system's umask is extremely restrictive, the log file is likely to be readable by users other than root.

* Security Test Case:
    1. Deploy the `ImdsPacketAnalyzer` tool on an EC2 instance. Run the tool as root using `sudo python3 src/imds_snoop.py`. Ensure the tool generates some log entries by making IMDSv1 and IMDSv2 calls (e.g., using `curl http://169.254.169.254/latest/meta-data/` and `curl -H X-aws-ec2-metadata-token-ttl-seconds: 300 -X PUT http://169.254.169.254/latest/api/token`).
    2. Log in to the EC2 instance as a non-root user (e.g., `ec2-user` on Amazon Linux or `ubuntu` on Ubuntu).
    3. Attempt to read the log file: `cat /var/log/imds/imds-trace.log`.
    4. **Expected Result (Vulnerability Present):** The non-root user should be able to read the log file and view the logged IMDS call details, including process information.
    5. **Remediation (Apply Mitigation):** Modify `src/imds_snoop.py` to explicitly set file permissions for the log file. Add the following line after the `c_handler` is initialized (inside both the `else` block and potentially within a similar logic if using `logging.conf`):
    ```python
    log_file_path = '/var/log/imds/imds-trace.log' # Define log file path
    c_handler.baseFilename = log_file_path # Ensure handler knows the path (might be needed for some handlers)
    os.chmod(log_file_path, 0o600) # Set permissions for the log file
    ```
    6. Redeploy the modified `ImdsPacketAnalyzer` and repeat steps 1-3.
    7. **Expected Result (Vulnerability Mitigated):** The non-root user should **not** be able to read the log file, and the `cat /var/log/imds/imds-trace.log` command should result in a "Permission denied" error.